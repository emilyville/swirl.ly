createuser -P -d -r -s swirly
createdb -O swirly watersheds

#postgis 2.x
psql -d watersheds -c "CREATE EXTENSION postgis;"

#postgis 1.5
psql -d watersheds -f /usr/share/postgresql/9.1/contrib/postgis-1.5/postgis.sql
psql -d watersheds -f /usr/share/postgresql/9.1/contrib/postgis-1.5/spatial_ref_sys.sql
psql -d watersheds -f /usr/share/postgresql/9.1/contrib/postgis_comments.sql

# http://spatialreference.org/ref/epsg/2227/
shp2pgsql -I -s 2227 SFP_watershed.shp | psql -d watersheds

#### transform dataset to lat-long projection

watersheds=# begin;
BEGIN
watersheds=# select AddGeometryColumn('sfp_watershed', 'geom_4269', 4269, 'MULTIPOLYGON', 2);
                         addgeometrycolumn                          
--------------------------------------------------------------------
 public.sfp_watershed.geom_4269 SRID:4269 TYPE:MULTIPOLYGON DIMS:2 
(1 row)


#postgis 2.x
watersheds=# update sfp_watershed set geom_4269 = ST_Transform(geom, 4269);
UPDATE 108

#postgis 1.5
watersheds=# update sfp_watershed set geom_4269 = ST_Transform(the_geom, 4269);

watersheds=# commit;


shp2pgsql -I -s 2277 watershed.shp | psql -d watersheds
watersheds=# begin;
BEGIN
watersheds=# select AddGeometryColumn('watershed', 'geom_4269', 4269, 'MULTIPOLYGON', 2);
commit;


# covert water treatment polygons to points
 select AddGeometryColumn('wastewater_plants', 'point_4269', 4269, 'Point', 2);

# add autin treatment plants
 insert into wastewater_plants (name1, point_4269) values ('Walnut Creek Wastewater Treatment Plant', ST_GeomFromText('Point(-97.65253 30.28252)', 4269));
insert into wastewater_plants (name1, point_4269) values ('South Austin Regional Wastewater Treatment Plant', ST_GeomFromText('Point(-97.60464 30.20800)', 4269));

# add existing columns as points
update wastewater_plants set point_4269 = ST_CENTROID(wastewater_plants.geom_4269) where point_4269 IS NULL;

#rename name column
alter table watershed rename display_na to name1;

#copy data from sfp_watershed table
begin; insert into watershed (name1, geom_4269) select name1, geom_4269 from sfp_watershed;

select name1, ST_AsText(ST_Centroid(geom_4269)) from sfp_watershed where ST_Contains(geom_4269, ST_PointFromText('POINT(-122.4501366 37.7682385)', 4269));

#add map key column
alter table wastewater_plants add column map_key varchar(50);
update wastewater_plants set map_key = 'emilyville.gb0chmmk' where name1 IN ('Southeast Treatment Plant', 'North Point Wet Weather Treatment Facility', 'Oceanside Treatment Plant');
update wastewater_plants set map_key = 'emilyville.hf313o03' where map_key IS NULL;
